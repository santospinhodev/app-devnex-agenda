// backend/prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum PaymentType {
  CASH
  CARD
  TRANSFER
  OTHER
}

model User {
  id             String    @id @default(uuid())
  email          String    @unique
  name           String?
  phone          String?
  hashedPassword String?
  isActive       Boolean   @default(true)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  deletedAt      DateTime?

  // Profiles
  barberProfile       BarberProfile?
  receptionistProfile ReceptionistProfile?

  // Relations
  permissions            UserPermission[]
  ownedBarbershops       Barbershop[]      @relation("BarbershopOwner")
  appointmentsAsCustomer Appointment[]     @relation("customerAppointments")
  appointmentsAsBarber   Appointment[]     @relation("barberAppointments")
  financialRecords       FinancialRecord[]
  notificationLogs       NotificationLog[]
  auditLogs              AuditLog[]        @relation("auditActor")

  @@map("users")
}

model Barbershop {
  id           String    @id @default(uuid())
  ownerId      String
  name         String
  phone        String?
  address      String?
  neighborhood String?
  city         String?
  state        String?
  zipCode      String?
  photoUrl     String?
  opensAt      String?
  closesAt     String?
  daysOpen     String[]  @default([])
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  deletedAt    DateTime?

  owner         User                  @relation("BarbershopOwner", fields: [ownerId], references: [id])
  barbers       BarberProfile[]
  receptionists ReceptionistProfile[]
  customers     CustomerProfile[]
  services      Service[]
  appointments  Appointment[]

  @@index([ownerId])
  @@map("barbershops")
}

model Permission {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users UserPermission[]

  @@map("permissions")
}

model UserPermission {
  id           Int        @id @default(autoincrement())
  user         User       @relation(fields: [userId], references: [id])
  userId       String
  permission   Permission @relation(fields: [permissionId], references: [id])
  permissionId Int
  grantedAt    DateTime   @default(now())

  @@unique([userId, permissionId])
  @@map("user_permissions")
}

model Service {
  id           String    @id @default(uuid())
  barbershopId String
  name         String
  description  String?
  durationMin  Int       @default(30)
  price        Decimal   @db.Decimal(10, 2)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  deletedAt    DateTime?

  barbershop   Barbershop    @relation(fields: [barbershopId], references: [id])
  appointments Appointment[]

  @@index([barbershopId])
  @@map("services")
}

model Appointment {
  id           String            @id @default(uuid())
  barbershopId String
  customer     User              @relation("customerAppointments", fields: [customerId], references: [id])
  customerId   String
  barber       User              @relation("barberAppointments", fields: [barberId], references: [id])
  barberId     String
  service      Service           @relation(fields: [serviceId], references: [id])
  serviceId    String
  startAt      DateTime
  endAt        DateTime
  status       AppointmentStatus @default(PENDING)
  price        Decimal           @db.Decimal(10, 2)
  notes        String?
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  deletedAt    DateTime?

  barbershop      Barbershop        @relation(fields: [barbershopId], references: [id])
  notifications   NotificationLog[]
  financialRecord FinancialRecord?

  @@index([barberId, startAt])
  @@index([customerId, startAt])
  @@index([barbershopId, startAt])
  @@map("appointments")
}

model CustomerProfile {
  id           String   @id @default(uuid())
  barbershopId String
  name         String
  phone        String
  avatarUrl    String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  barbershop Barbershop @relation(fields: [barbershopId], references: [id])

  @@index([barbershopId])
  @@map("customer_profiles")
}

model BarberProfile {
  id                   String   @id @default(uuid())
  user                 User     @relation(fields: [userId], references: [id])
  userId               String   @unique
  barbershopId         String
  name                 String
  phone                String?
  avatarUrl            String?
  commissionPercentage Float?
  bio                  String?
  isActive             Boolean  @default(true)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  barbershop Barbershop @relation(fields: [barbershopId], references: [id])

  @@index([barbershopId])
  @@map("barber_profiles")
}

model ReceptionistProfile {
  id           String   @id @default(uuid())
  user         User     @relation(fields: [userId], references: [id])
  userId       String   @unique
  barbershopId String
  name         String
  phone        String?
  avatarUrl    String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  barbershop Barbershop @relation(fields: [barbershopId], references: [id])

  @@index([barbershopId])
  @@map("receptionist_profiles")
}

model FinancialRecord {
  id            String       @id @default(uuid())
  appointment   Appointment? @relation(fields: [appointmentId], references: [id])
  appointmentId String?      @unique
  type          PaymentType
  amount        Decimal      @db.Decimal(10, 2)
  description   String?
  recordedBy    User?        @relation(fields: [recordedById], references: [id])
  recordedById  String?
  recordedAt    DateTime     @default(now())
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  @@map("financial_records")
}

model NotificationLog {
  id            String       @id @default(uuid())
  appointment   Appointment? @relation(fields: [appointmentId], references: [id])
  appointmentId String?
  user          User?        @relation(fields: [userId], references: [id])
  userId        String?
  channel       String
  event         String
  payload       Json?
  status        String
  sentAt        DateTime?
  createdAt     DateTime     @default(now())

  @@index([appointmentId])
  @@map("notification_logs")
}

model AuditLog {
  id        String   @id @default(uuid())
  actor     User?    @relation("auditActor", fields: [actorId], references: [id])
  actorId   String?
  action    String
  entity    String
  entityId  String?
  changes   Json?
  ip        String?
  createdAt DateTime @default(now())

  @@map("audit_logs")
}

/// Prisma schema notes:
/// - Soft deletes use `deletedAt` DateTime? fields when defined.
/// - Use Decimal type for monetary values. Ensure the client uses Decimal handling.
/// - The schema maps table names explicitly for clarity.
